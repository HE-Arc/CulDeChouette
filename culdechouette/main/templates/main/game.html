{% extends "main/base.html" %}
{% block content %}

<style>
#container {
    display: flex;
}

#game_table {
    padding-right: 50px;
}

#chat-log, #chat-message-input {
    width:400px;
}
</style>

<div id="container">
    <div id="game_table">
        <div id="score">
            <p>Scores</p>
            <!--TODO : Add dynamic scores of actives players-->
        </div>
        <h4>Lel's turn</h4> <!--TODO : Add current player's name in lieu of Lel-->
        <canvas id="dice_table" width="1000" height="300"></canvas><br>
        <button>Grelotte Ã§a picote !</button>
        <button>Pas mou le caillou !</button>
        <button>Throw dices</button>

        <script>
            let diceTable = document.getElementById("dice_table");
            let ctx = diceTable.getContext("2d");
            ctx.fillStyle = "#FF0000";
            ctx.fillRect(0,0,1000,300);
            ctx.font = "50px Arial";
            ctx.fillStyle = "#FFFFFF";
            ctx.fillText("Replaced by rolling dices asap", 150, 150);
        </script>
    </div>

    <div id="chat">
        {% comment %} <h4 id="connectionName"></h4> {% endcomment %}
        <textarea id="chat-log" cols="100" rows="20"></textarea><br>
        <input id="chat-message-input" type="text" size="100"><br>
        <input id="chat-message-submit" type="button" value="Send">
        {{ room_name|json_script:"room-name" }}
        {{ user |json_script:"user" }}

        <script>
            const roomName = JSON.parse(document.getElementById('room-name').textContent);
            user = JSON.parse(document.getElementById('user').textContent);
            user = JSON.parse(user);
            const username = user.fields.username;
            const id = user.pk
            {% comment %} document.querySelector('#connectionName').textContent ="Connected as "+username; {% endcomment %}
            
            const chatSocket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/chat/'
                + roomName
                + '/'
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                document.querySelector('#chat-log').value += (data.message + '\n');
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {  // enter, return
                    document.querySelector('#chat-message-submit').click();
                }
            };

            document.querySelector('#chat-message-submit').onclick = function(e) {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = "["+username+"]"+messageInputDom.value;
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                messageInputDom.value = '';
            };
        </script>
    </div>
</div>
{% endblock content %}